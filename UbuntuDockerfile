FROM ubuntu
LABEL maintainer="Sebastian Oehms <seb.oehms@gmail.com>"
ENV LC_ALL C.UTF-8
ENV LANG C.UTF-8
ENV SHELL /bin/bash
RUN apt-get -qq update \
    && apt-get -qq install -y --no-install-recommends sudo docker.io ca-certificates fuse curl \
    && apt-get -qq clean \
    && rm -r /var/lib/apt/lists/*
ARG HOME=/home/pwsh
RUN adduser --quiet --shell /bin/bash --gecos "Powershell user,101,," --disabled-password --home "$HOME" pwsh \
    && echo "pwsh ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/01-pwsh \
    && chmod 0440 /etc/sudoers.d/01-pwsh
# Run everything from now on as the pwsh user in pwsh's home
RUN echo "[boot]\nsystemd=true\n" > /etc/wsl.conf \
    && echo "[user]\ndefault=pwsh" >> /etc/wsl.conf
USER pwsh
ENV HOME $HOME
WORKDIR $HOME
RUN sudo usermod -aG docker pwsh \
    && sudo update-ca-certificates \
    && mkdir -p ~/bin \
    && echo "sudo dockerd --host=unix:///var/run/docker.sock &" > ~/bin/start_dockerd \
    && chmod a+x ~/bin/start_dockerd
